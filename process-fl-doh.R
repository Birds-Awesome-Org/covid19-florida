#! /usr/bin/env Rscript
options(error = NULL)
message("Check start - ", strftime(Sys.time(), "%F %T", tz = "America/New_York"))

# Library ----
library(tidyr, warn.conflicts = FALSE)
library(purrr, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(stringr, warn.conflicts = FALSE)
library(lubridate, warn.conflicts = FALSE)
library(glue, warn.conflicts = FALSE)
library(fs, warn.conflicts = FALSE)
library(xml2, warn.conflicts = FALSE)
library(rvest, warn.conflicts = FALSE)
library(readr, warn.conflicts = FALSE)

dir_create("snapshots")

# Functions ----
timestamp_from_node <- function(node) {
  text <- xml_text(node)
  time <- str_extract(text, "\\d{1,2}:\\d{2} [APMapm.]+")
  date <- str_extract(text, "(\\d+[/.-]?){3}")
  mdy_hm(glue("{date} {time}"), tz = "America/New_York")
}

append_csv <- function(data, path) {
  existing_data <- if (file.exists(path)) {
    read_csv(path)
  }
  write_csv(bind_rows(existing_data, data), path)
}

# Add random wait time to offset regularity of cronlog
if (!interactive()) {
  wait_time <- runif(1, 0, 120)
  message("Waiting ", round(wait_time, 2), "s")
  Sys.sleep(wait_time)
}

# Get FL DOH Main Page ----
fl_doh_url <- "http://www.floridahealth.gov/diseases-and-conditions/COVID-19/"

fl_doh <- read_html(fl_doh_url)
fl_doh_digest <- digest::sha1_digest(xml_text(fl_doh))
ts_now <- now()
ts_current <- strftime(ts_now, '%FT%H%M%S', tz = "America/New_York")

# Check hash of latest with hash of last update ----
if (file.exists(".last-update")) {
  last_update <- readLines(".last-update", warn = FALSE)
  if (last_update[1] == fl_doh_digest) {
    cat("\n", glue("Checked: {ts_current}"), file = ".last-update", append = TRUE, sep = "")
    message("No updates - ", strftime(Sys.time(), "%F %T", tz = "America/New_York"))
    stop("No updates at this time")
    quit("n", 1)
  }
}

write_html(fl_doh, path("snapshots", strftime(ts_now, 'fl_doh_main_%FT%H%M%S', tz = "America/New_York"), ext = "html"))

# FL DOH Table Timestamp ----
timestamp_page <- fl_doh %>% xml_node("block p sup") %>% timestamp_from_node()

# Reset last run log
writeLines(
  c(
    fl_doh_digest, 
    glue("DOH Page: {timestamp_page}"),
    glue("Read: {ts_current}")
  ), 
  con = ".last-update"
)

table_rows <- c(
  "Confirmed Cases in Florida Residents",
  "Cases in Non-Florida Residents",
  "Total Cases Overview"
)

fl_doh %>% 
  html_table() %>% 
  bind_rows() %>% 
  as_tibble() %>% 
  set_names(c("variable", "count")) %>% 
  mutate(
    header = variable %in% table_rows,
    .group = cumsum(header),
    header = if_else(header, "group", "subgroup")
  ) %>% 
  nest(data = -c(header, .group)) %>% 
  pivot_wider(
    names_from = header, 
    values_from = data
  ) %>% 
  mutate(group = map(group, ~ .x %>% rename(total = count, group = variable))) %>% 
  unnest(cols = c(group, subgroup)) %>% 
  mutate_if(is.character, tolower) %>% 
  mutate(
    group = case_when(
      str_detect(group, "in florida residents") ~ "resident",
      str_detect(group, "non-florida residents") ~ "non_resident",
      str_detect(group, "total cases") ~ "total"
    )
  ) %>% 
  filter(group != "total") %>% 
  mutate(
    variable = case_when(
      str_detect(variable, "doh") ~ "doh",
      str_detect(variable, "private") ~ "private",
      str_detect(variable, "isolated") ~ "resident_outside",
      str_detect(variable, "death") ~ "deaths"
    ),
    case = if_else(str_detect(variable, "deaths"), "deaths", "cases")
  ) %>% 
  filter(variable != "resident_outside") %>%
  group_by(group, case) %>% 
  summarize(count = sum(count)) %>% 
  ungroup() %>% 
  complete(
    group = c("resident", "non_resident"), 
    case = c("cases", "deaths"), 
    fill = list(count = 0)
  ) %>% 
  arrange(desc(group)) %>% 
  pivot_wider(names_from = c(group, case), values_from = count) %>% 
  mutate(timestamp = ts_current) %>% 
  select(timestamp, everything()) %>% 
  append_csv("covid-19-florida-cases.csv")


# Florida County Cases from arcgis Dashboard ------------------------------

fl_dash_url <- "https://fdoh.maps.arcgis.com/apps/opsdashboard/index.html#/8d0de33f260d444c852a615dc7837c86"

fl_dash <- read_html(fl_dash_url)

fl_dash %>% 
  xml_nodes("div:nth-child(2) > margin-container p")

chrm <- chromote::ChromoteSession$new()
chrm$Page$navigate(fl_dash_url)
chrm$Page$loadEventFired()
Sys.sleep(5)

dom <- chrm$DOM$getDocument()
writeLines(
  chrm$DOM$getOuterHTML(dom$root$nodeId)$outerHTML, 
  path("snapshots", strftime(ts_now, 'fl_doh_dash_%FT%H%M%S', tz = "America/New_York"), ext = "html")
)
ids <- chrm$DOM$querySelectorAll(dom$root$nodeId, "div:nth-child(2) > margin-container p")
boxes <- map(unlist(ids), ~ chrm$DOM$getOuterHTML(.x))

boxes %>% 
  map("outerHTML") %>% 
  map(read_html) %>% 
  map(xml_nodes, "p") %>% 
  map_chr(xml_text) %>% 
  str_trim() %>% 
  str_subset("^$", negate = TRUE) %>% 
  str_subset("Number of Cases", negate = TRUE) %>% 
  tibble(raw = .) %>% 
  separate(raw, c("county", "count"), sep = ": ") %>% 
  mutate_at(vars(county), str_remove, pattern = "\\s*County") %>% 
  mutate_at(vars(count), as.character) %>% 
  mutate(timestamp = ts_current) %>% 
  select(timestamp, everything()) %>% 
  append_csv("covid-19-florida-cases-county.csv")

chrm$close()

# Push changes to repo ----
if (git2r::in_repository()) {
  is_dirty <- rlang::has_length(git2r::status(untracked = FALSE)$unstaged)
  if (is_dirty) {
    git2r::add(".", ".")
    git2r::commit(message = glue("[auto update] {ts_current}"))
    git2r::push(credentials = git2r::cred_ssh_key())
  }
}

message("Check end - ", strftime(Sys.time(), "%F %T", tz = "America/New_York"))
